\section{Pontryagin's Maximum Principle}
Optimal control with PMP will consider the continous formulations of the control problems.
\todo{I do think this is the correct formulation, considering that control inputs $u$ are chosen at every timestep. For the IPOPT/SQP objective formulations the problem is condensed, so in this case I assume that the objective is partially concave? Work in progress}
\begin{mini*}|s|
{w}{\int_{t=0}^T I(t)^2 -W_u u(t)^2}
{}{}
%\addConstraint{x_f = f(x_0, u(t))}
\addConstraint{\dot{x}(t) = F(x(t), u(t))}
\addConstraint{u_{max} \geq u(t) \geq u_{min}, \quad \forall t \in [0, T)}{}
\end{mini*}
Where $F(.)$ is the SIR ODE-dynamics. The hamiltonians for the problem becomes:
\begin{align}
    H(x, \lambda, u) &= L(I(t), u(t)) + \lambda^T F(x(t), u(t))\\
    H_{SD}(x, \lambda, u) &= I(t)^2 - W_u u(t)^2 + (\lambda_1 - \lambda_0)\cdot u(t)\frac{S(t)I(t)}{N_{pop}}\\ &+ (\lambda_2 -\lambda_1) \alpha I(t)\nonumber\\
    H_{V}(x, \lambda, u) &= I(t)^2 + W_uu(t)^2 + (\lambda_1 - \lambda_0)\cdot \beta \frac{S(t)I(t)}{N_{pop}} \\&- (\lambda_0 + \lambda_2) u + (\lambda_2 -\lambda_1) \alpha I(t)\nonumber\\
    H_{q}(x, \lambda, u) &= I(t)^2 + W_uu(t)^2 + (\lambda_1 - \lambda_0)\cdot \beta \frac{S(t)I(t)}{N_{pop}} \\&- (\lambda_1 + \lambda_2) u + (\lambda_2 -\lambda_1) \alpha I(t)\nonumber
\end{align}
Minimizing the hamiltonian every timestep will minimize the objective function. In the case of social distancing ($H_{SD}$) it is possible to derive an unconstrained solution:
\begin{align}
    \argmin_u  H_{SD}(x, \lambda, u) &\rightarrow u^* = \pm \infty %\frac{\partial H(x, \lambda, u)}{\partial u} = 0\\
     %u &= \frac{(\lambda_1-\lambda_0)}{2W_u}\cdot \frac{S(t)I(t)}{N_{pop}}
\end{align}
Constraints $u_{min} \leq u \leq u_{max}$ cannot have the same optimum. However, the concavity of hamiltonian with respect to $u$ ensures that the following holds for constrained $u_c^*(t)$:
\begin{align}
    u^*(t) &= \argmin_u H_{SD}(x, \lambda, u)\\
    u_c^*(t) &= \begin{cases}
    u_{min} \mbox{ if } H_{SD}(x, \lambda, u_{min}) < H_{SD}(x, \lambda, u_{max})\\
    u_{max} \mbox{ otherwise }
    \end{cases}
\end{align}

In the case of vaccination and isolation control ($H_V, H_q$) the minimization problem is convex.

\begin{align}
    u^*_V(t) &= \argmin_u H_{V}(x, \lambda, u)\rightarrow u^*_V = -\frac{\lambda_2-\lambda_0}{2W_u}\\
    u^*_q(t) &= \argmin_u H_{q}(x, \lambda, u)\rightarrow u^*_q = -\frac{\lambda_2 - \lambda_1}{2W_u}\\
    u_{c}^*(t) &= \begin{cases}
    u_{min} \mbox{ if } u^* < u_{min}\\
    u^* \mbox{ if } u_{min} \leq u^* \leq u_{max}\\
    u_{max}  \mbox{ if } u^* > u_{max}\\
    \end{cases}
\end{align}

The equality constraint multipliers are updated using the jacobian of the hamiltonian, yielding the following differential equations and conditions:
\begin{align}
    \begin{split}
    \dot{x} &= F(x, u)\\
    \dot{\lambda} &= -\nabla H_x(x, \lambda, u)\\
    x(t_0) &= x_0\\
    \lambda(t_f) &= 0
    \end{split}
\end{align}
The two point boundary value problem must be solved. Since $\lambda_0$ is unavailable $\lambda(t_f)$ must be solved by repeatedly 'guessing' $\lambda_0$ and simulating the system forward. The initial guess can be corrected using Newton-Rhapson for each simulation:
\begin{equation}
    \lambda(t_0) = \lambda(t_0) - \frac{\partial \lambda(t_f)}{\partial \lambda(t_0)}^{-1} \lambda(t_f)
\end{equation}

\subsection{Single-Shooting}
The analytical optimal solution for $u$ removes the need for nonlinear optimization and iterations, but CasADI's symbolical framework is still useful for constructing the integrator. 

\begin{algorithm}[H]
\SetAlgoLined
\KwData{$x_k = x_0, u = [u_0, \dots, u_{N-1}],\lambda_k = \lambda_0, h, N$}
Construct integrator $f(ODE, x, u, h)$ with CasADI-symbolics\\
\While{$\lambda(t_f) > tol$}{
 \For{$i$ = 0 : $N-1$}{
    $u^*_{c, k} = \argmin_u H(x, \lambda_k, u)$\\
    $x_k$ = $f(@SIR, x_k, u^*_{c, k}, h)$\\
    $\lambda_k$ = $f(@(-\nabla_xH(x, \lambda_k, u^*_{c,k})), x_k, u^*_{c,k}, h)$
 }
     $\lambda_0 = \lambda_0 - \frac{\partial \lambda(t_f)}{\partial \lambda_0}^{-1} \lambda(t_f)$\\
     $\lambda_k = \lambda_0$
 }
 \caption{Single-shooting with PMP}
 \label{alg:SingleShooting_Integration_PMP}
\end{algorithm}

\subsection{Results}
\subsubsection{Vaccination}
\subsubsection{Social Distancing}
\subsubsection{Isolation}

\subsection{Multiple-Shooting}
Newton-Rhapson in PMP may struggle to converge both due to initial guess $\lambda(t_0)$ and the system dynamics. To account for this, the states can be lifted in order to give multiple sets of constraints to be satisfied.

\begin{align}
    \begin{bmatrix}
    x(t_0) - x_0\\
    x_1 - f(@SIR, x_0, u^*_{c, 0}, h)\\
    \lambda_1 - f(@(-\nabla_xH(x_0, \lambda_0, u^*_{c,0})), x_0, u^*_{c,0}, h)\\
    \vdots\\
    x_1 - f(@SIR, x_{N-1}, u^*_{c, N-1}, h)\\
    \lambda_N - f(@(-\nabla_xH(x_{N-1}, \lambda_{N-1}, u^*_{c,{N-1}})), x_{N-1}, u^*_{c,N-1}, h)\\
    \lambda_N
    \end{bmatrix} = 0
\end{align}

\begin{algorithm}[H]
\SetAlgoLined
\KwData{$X = MX\in \mathbb{R}^{N\times 3}, \lambda = MX\in \mathbb{R}^{N\times 3}, u = [u_0, \dots, u_{N-1}],\lambda_0, h, N$}
Construct integrator $f(ODE, x, u, h)$ with CasADI-symbolics\\

$r = []$\\
 \For{$i$ = 0 : $N-1$}{
    $u^*_{c, k} = \argmin_u H(x, \lambda_k, u)$\\
    add $x_k - f(@SIR, x_k, u^*_{c, k}, h)$ to g\\
    add $\lambda_k - f(@(-\nabla_xH(x, \lambda_k, u^*_{c,k})), x_k, u^*_{c,k}, h)$ to r
 }
 Set initial guess $S_0 = [x_0, \lambda_0, \dots, x_f, \lambda_f]$\\
 \While{$|r(S_k)| > tol$}{
     $S_k = S_k - \frac{\partial r(S_k)}{\partial S_k}^{-1} r(S_k)$\\
 }
 \caption{Multiple-shooting with PMP}
 \label{alg:Multiple_Shooting_Integration_PMP}
\end{algorithm}

\todo{Implementation in CasADI}
\subsection{Results}
\subsubsection{Vaccination}
\subsubsection{Social Distancing}
\subsubsection{Isolation}





